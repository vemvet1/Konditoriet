<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Page</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
    <script>
        function initializePaymentPage() {
            let product_id = new URLSearchParams(window.location.search).get('tgWebAppStartParam');
    
            const mainButton = Telegram.WebApp.MainButton;
            const secondaryButton = Telegram.WebApp.SecondaryButton;
    
            setupButton(mainButton, 'Pay via Crypto', 'crypto', product_id);
            setupButton(secondaryButton, 'Pay via Stars', 'stars', product_id);
        }
    
        function setupButton(button, buttonText, paymentMode, product_id) {
            button.setParams({
                text: buttonText,
                color: '#000000',
                text_color: '#003297',
                is_active: true,
                is_visible: true, 
                has_shine_effect: true
            });
            button.onClick(() => handleButtonClick(button, paymentMode, product_id));
        }
    
        async function handleButtonClick(button, paymentMode, product_id) {
            const api_url = `https://funny-marginally-rabbit.ngrok-free.app/invoice/${product_id}`;
            button.showProgress(true);
            try {
                const invoice_url = await initiatePayment(api_url, paymentMode, product_id);
                if (invoice_url) {
                    if (paymentMode === 'crypto'){
                        Telegram.WebApp.openLink(invoice_url);
                         Telegram.WebApp.close();
                    } else {
                        Telegram.WebApp.openInvoice(invoice_url);
                    }
                } else {
                    alert("Failed to retrieve the payment link. Please try again.");
                }
            } finally {
                button.hideProgress();
            }
        }
    
        async function initiatePayment(api_url, paymentMode, product_id) {
            const form = document.getElementById('userForm');
            const formData = new FormData(form);
            const data = { payment_mode: paymentMode, product_id: product_id };
    
            formData.forEach((value, key) => {
                data[key] = value;
            });
    
            const response = await fetch(api_url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-token': Telegram.WebApp.initData
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error(`HTTP status ${response.status}`);
            }
                return await response.text();
        }
    
        document.addEventListener('DOMContentLoaded', initializePaymentPage);
    </script>
</head>
<body>
    <form id="userForm">
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>

        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>

        <label for="address">Address:</label>
        <input type="text" id="address" name="address" required>
    </form>
</body>
</html>
