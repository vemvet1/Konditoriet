<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Page</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
    <script>

        let product_id = new URLSearchParams(window.location.search).get('tgWebAppStartParam');
        
        window.Telegram.WebApp.onEvent('invoiceClosed', function(url, status) {
            window.Telegram.WebApp.MainButton.hideProgress();
            window.Telegram.WebApp.close();
        });

        const mainButton = window.Telegram.WebApp.MainButton;
        mainButton.setParams({
            text: `Pay via Stars`,
            color: '#000000', 
            text_color: '#003297',
            is_active: true,
            is_visible: true
        });

        const secondaryButton = window.Telegram.WebApp.SecondaryButton;
        secondaryButton.setParams({
            text: 'Pay via Crypto',
            color: '#000000', 
            text_color: '#003297',
            is_active: true, 
            is_visible: true,
            position: 'right'
        });

        async function handlePayment(api_url, payment_mode) {
            try {
                const form = document.getElementById('userForm');
                const formData = new FormData(form);
                const data = {payment_mode: payment_mode};

                formData.forEach((value, key) => {
                    data[key] = value;
                });


                const response = await fetch(api_url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-token': window.Telegram.WebApp.initData
                    },
                    body: JSON.stringify(data),
                });

                if (response.status === 404) {
                    alert('Product not available');
                    window.Telegram.WebApp.close();
                    throw new Error('Product not available');
                } else if (response.status === 401) {
                    alert('User not authenticated');
                    window.Telegram.WebApp.close();
                    throw new Error('User not authenticated');
                } else if (!response.ok) {
                    throw new Error('Something went wrong');
                }

                const url = await response.json();
                console.log(url);
                return url;

            } catch (error) {
                console.log(error);
                alert("Something went wrong!");
            }
        }

        mainButton.onClick(async () => {
            mainButton.showProgress(true);
            const api_url = `https://funny-marginally-rabbit.ngrok-free.app/invoice/${product_id}`;
            // const api_url = `https://pay.bestbot.link/invoice/${product_id}`;
            const invoice_url = await handlePayment(api_url, 'stars'); 

            // Error handling if invoice_url is not returned
            if (!invoice_url) {
                alert("Failed to retrieve the payment link. Please try again.");
                mainButton.hideProgress();
                return;
            }

            window.Telegram.WebApp.openInvoice(invoice_url);
            mainButton.hideProgress();
        });

        secondaryButton.onClick(async () => {
            secondaryButton.showProgress(true);
            const api_url = `https://funny-marginally-rabbit.ngrok-free.app/crypto_invoice/${product_id}`;
            // const api_url = `https://pay.bestbot.link/crypto_invoice/${product_id}`;
            const invoice_url = await handlePayment(api_url, 'crypto');

            // Error handling if invoice_url is not returned
            if (!invoice_url) {
                alert("Failed to retrieve the payment link. Please try again.");
                secondaryButton.hideProgress();
                return;
            }

            window.Telegram.WebApp.openLink(invoice_url); 
            window.Telegram.WebApp.close();
        });

    </script>
</head>
<body>
    <form id="userForm">
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>

        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>

        <label for="address">Address:</label>
        <input type="text" id="address" name="address" required>
    </form>
</body>
</html>
